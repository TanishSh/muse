<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Muse S Data to CSV</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    button { margin: 0.5em; padding: 0.5em 1em; font-size: 1em; }
    pre { background: #f0f0f0; padding: 1em; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>Muse S Data to CSV</h1>
  <button id="connectButton">Connect to Muse S</button>
  <button id="downloadButton" disabled>Download CSV</button>
  <pre id="log"></pre>
  
  <!-- This script uses ES modules; you must serve this page via a web server -->
  <script type="module">
    /* 
      IMPORTANT:
      muse‑js is not available directly via a CDN.
      You must install it using npm and bundle this code with a bundler (e.g., Parcel, Vite, or Webpack).
    */
    import { MuseClient } from './muse-js';
    
    const logElement = document.getElementById('log');
    function log(message) {
      console.log(message);
      logElement.textContent += message + "\n";
    }
    
    // CSV header (we’ll record EEG readings from 4 channels: TP9, AF7, AF8, TP10)
    let csvData = "Timestamp,TP9,AF7,AF8,TP10\n";
    
    const client = new MuseClient();
    
    document.getElementById('connectButton').addEventListener('click', async () => {
      try {
        log("Requesting Bluetooth device...");
        // This will prompt you to choose your Muse S
        await client.connect();
        log("Connected to Muse S.");
        
        // Log connection status updates
        client.connectionStatus.subscribe(status => {
          log("Connection Status: " + status);
        });
        
        // Start streaming data from Muse
        client.start();
        log("Started data stream.");
        
        // Subscribe to EEG readings
        client.eegReadings.subscribe(reading => {
          // Each reading contains a data array with values for 4 channels: [TP9, AF7, AF8, TP10]
          const timestamp = new Date().toISOString();
          const [tp9, af7, af8, tp10] = reading.data;
          const line = `${timestamp},${tp9},${af7},${af8},${tp10}\n`;
          csvData += line;
          log("EEG Reading: " + line.trim());
        });
        
        // Enable the download button once connected and streaming
        document.getElementById('downloadButton').disabled = false;
      } catch (err) {
        log("Error: " + err);
      }
    });
    
    document.getElementById('downloadButton').addEventListener('click', () => {
      // Create a Blob from the CSV data and trigger a download
      const blob = new Blob([csvData], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'muse_data.csv';
      a.click();
      URL.revokeObjectURL(url);
      log("CSV file downloaded.");
    });
  </script>
</body>
</html>
